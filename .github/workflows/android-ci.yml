on:
  push:
    branches: [ main ]
    tags: [ "v*" ]  # 只有 tag 才完整构建
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          
      # 只在 tag 推送时签名
      - name: Decode keystore (tag only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > $GITHUB_WORKSPACE/release.jks
          
      - name: Build APK
        env:
          KEYSTORE_PATH: ${{ github.workspace }}/release.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # tag 推送：签名构建
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
              -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
              -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
              -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
          else
            # 普通推送：不签名构建
            ./gradlew assembleRelease
          fi